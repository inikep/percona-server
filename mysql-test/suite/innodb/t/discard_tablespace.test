--echo #
--echo # PS-7865: Dropping a table with discarded tablespace crashes the server
--echo #

CREATE TABLE t1(a INT)ENGINE=innodb;
INSERT INTO t1 VALUES (10);
SELECT * FROM t1 INTO OUTFILE 'tmp1.txt';
LOAD DATA INFILE 'tmp1.txt' INTO TABLE t1;
SELECT * FROM t1 INTO OUTFILE 'tmp2.txt';
LOAD DATA INFILE 'tmp2.txt' INTO TABLE t1;
SELECT * FROM t1 INTO OUTFILE 'tmp3.txt';
LOAD DATA INFILE 'tmp3.txt' INTO TABLE t1;
SELECT * FROM t1 INTO OUTFILE 'tmp4.txt';
LOAD DATA INFILE 'tmp4.txt' INTO TABLE t1;
SELECT * FROM t1 INTO OUTFILE 'tmp5.txt';
LOAD DATA INFILE 'tmp5.txt' INTO TABLE t1;
SELECT * FROM t1 INTO OUTFILE 'tmp6.txt';
LOAD DATA INFILE 'tmp6.txt' INTO TABLE t1;
SELECT * FROM t1 INTO OUTFILE 'tmp7.txt';
LOAD DATA INFILE 'tmp7.txt' INTO TABLE t1;
SELECT * FROM t1 INTO OUTFILE 'tmp8.txt';
LOAD DATA INFILE 'tmp8.txt' INTO TABLE t1;
SELECT * FROM t1 INTO OUTFILE 'tmp9.txt';
LOAD DATA INFILE 'tmp9.txt' INTO TABLE t1;
SELECT * FROM t1 INTO OUTFILE 'tmp10.txt';
LOAD DATA INFILE 'tmp10.txt' INTO TABLE t1;
ALTER TABLE t1 DISCARD TABLESPACE;
DROP TABLE t1;

--echo #
--echo # Bug #29793800 ASSERT AFTER DISCARD TABLESPACE, RENAME TABLE AND
--echo # CREATE TABLE USING SAME NAME.
--echo #

--disable_query_log
call mtr.add_suppression("\\[Warning\\] .*MY-\\d+.* Trying to access missing tablespace .*");
--enable_query_log

LET $MYSQLD_DATADIR = `select @@datadir`;
LET $INNODB_PAGE_SIZE = `select @@innodb_page_size`;

--echo # Test Case 1:
CREATE TABLE t1(b INT)ENGINE=innodb;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

ALTER TABLE t1 DISCARD TABLESPACE;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

ALTER TABLE t1 RENAME t2;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

CREATE TABLE t1(c INT)ENGINE=myisam;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

alter table t1 engine=innodb;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

drop table t1;
drop table t2;

--echo # Test Case 2:
CREATE TABLE t1(b INT)ENGINE=innodb;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

ALTER TABLE t1 DISCARD TABLESPACE;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

ALTER TABLE t1 RENAME t2;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

CREATE TABLE t1(c INT)ENGINE=innodb;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

drop table t1;
drop table t2;

--echo # Test Case 3:

CREATE TABLE `t1/t2` (b INT, c text) ENGINE=innodb;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

ALTER TABLE `t1/t2` DISCARD TABLESPACE;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

ALTER TABLE `t1/t2` RENAME `t3\t4\t5`;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

drop table `t3\t4\t5`;

--echo # Test Case 4:

create database `d1/d2\d3`;
use `d1/d2\d3`;

CREATE TABLE `t1/t2\t3` (b INT, c text) ENGINE=innodb;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

ALTER TABLE `t1/t2\t3` DISCARD TABLESPACE;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

ALTER TABLE `t1/t2\t3` RENAME `t3\t4/t5`;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

drop table `t3\t4/t5`;
drop database `d1/d2\d3`;

--echo # Test Case 5:

create database `d1/d2\d3`;
create database `d4/d5\d6`;

CREATE TABLE `d1/d2\d3`.`t1/t2\t3` (b INT, c text) ENGINE=innodb;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

ALTER TABLE `d1/d2\d3`.`t1/t2\t3` DISCARD TABLESPACE;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

ALTER TABLE `d1/d2\d3`.`t1/t2\t3` RENAME `d4/d5\d6`.`t3\t4/t5`;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

drop table `d4/d5\d6`.`t3\t4/t5`;
drop database `d1/d2\d3`;
drop database `d4/d5\d6`;

--echo # Test Case 6:
create database `d1/d2`;
create database `d1`;

CREATE TABLE `d1/d2`.`t1/t2` (b INT, c text) ENGINE=innodb;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

ALTER TABLE `d1/d2`.`t1/t2` DISCARD TABLESPACE;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

ALTER TABLE `d1/d2`.`t1/t2` RENAME `d1`.`d2/t1/t2`;
--source suite/innodb/include/show_i_s_tables.inc
--source suite/innodb/include/show_i_s_tablespaces.inc

drop table `d1`.`d2/t1/t2`;
drop database `d1/d2`;
drop database `d1`;