--source include/galera_cluster.inc

--disable_query_log
SET @create_var1 = "";
--let $count = 1017
while ($count)
{
  --eval SET @create_var1 = CONCAT(@create_var1, "f", $count, " CHAR(1) DEFAULT 'A', ")
  --dec $count
}

--let $create_var = `SELECT @create_var1`
--eval CREATE TABLE t1 ($create_var PRIMARY KEY (f1, f1017)) ENGINE=InnoDB;
--enable_query_log

INSERT INTO t1 (f1) VALUES (DEFAULT);

--connection node_2
SELECT f1 = 'A', f1017 = 'A' FROM t1;
UPDATE t1 SET f1 = 'X', f1017 = 'X' ;

--connection node_1
SELECT f1 = 'X', f1017 = 'X' FROM t1 WHERE f1 = 'X' AND f1017 = 'X';


# Deadlock

--connection node_1
SET AUTOCOMMIT=OFF;
START TRANSACTION;
UPDATE t1 SET f2 = 'K' WHERE f1 = 'X' AND f1017 = 'X';

--connection node_2
SET AUTOCOMMIT=OFF;
START TRANSACTION;
UPDATE t1 SET f2 = 'C' WHERE f1 = 'X' AND f1017 = 'X';
COMMIT;

--connection node_1
--error ER_LOCK_DEADLOCK
COMMIT;
ROLLBACK;

--connection node_2
ROLLBACK;

# Rollback

--connection node_1
START TRANSACTION;
INSERT INTO t1 (f1, f1017) VALUES ('B','B');
INSERT INTO t1 (f1, f1017) VALUES ('C','C');
INSERT INTO t1 (f1, f1017) VALUES ('E','E');
INSERT INTO t1 (f1, f1017) VALUES ('F','F');
ROLLBACK;
SELECT COUNT(*) = 1 FROM t1;

--connection node_2
SELECT COUNT(*) = 1 FROM t1;

DROP TABLE t1;
