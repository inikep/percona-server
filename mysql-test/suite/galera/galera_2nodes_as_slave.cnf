#
# This .cnf file creates a setup with 1 standard MariaDB server, followed by a 2-node Galera cluster
#

# Use default setting for mysqld processes
!include include/default_mysqld.cnf

[mysqld]
binlog-format=row

# disable wsrep watchdog for testing
innodb-wsrep-applier-lock-wait-timeout=0

[mysqld.1]
wsrep_on=1

log-bin=master-bin
log-bin-index=master-bin
log-replica-updates

innodb-autoinc-lock-mode=2
default-storage-engine=innodb
wsrep_provider=@env.WSREP_PROVIDER
wsrep_node_address=127.0.0.1
wsrep-cluster-address=gcomm://
wsrep_provider_options='base_port=@mysqld.1.#galera_port;gcache.size=10M'
wsrep_node_incoming_address=127.0.0.1:@mysqld.1.port
wsrep_sst_receive_address='127.0.0.1:@mysqld.1.#sst_port'

# enforce read-committed characteristics across the cluster
wsrep-sync-wait=15
server-id=1
# lock schedule alg appears to be VATS by default, and it is not
# yet compatible with galera
#innodb_lock_schedule_algorithm=FCFS

mysqlx_port=@mysqld.1.loose-mysqlx-port

[mysqld.2]
wsrep_on=1

log-bin=master-bin
log-bin-index=master-bin
log-replica-updates

relay-log=relay-bin
relay-log-index=relay-bin

innodb-autoinc-lock-mode=2
default-storage-engine=innodb
wsrep_provider=@env.WSREP_PROVIDER
wsrep_node_address=127.0.0.1
wsrep_cluster_address='gcomm://127.0.0.1:@mysqld.1.#galera_port'
wsrep_provider_options='base_port=@mysqld.2.#galera_port;gcache.size=10M'
wsrep_node_incoming_address=127.0.0.1:@mysqld.2.port
wsrep_sst_receive_address='127.0.0.1:@mysqld.2.#sst_port'

# enforce read-committed characteristics across the cluster
wsrep-sync-wait=15
server-id=2
# lock schedule alg appears to be VATS by default, and it is not
# yet compatible with galera
#innodb_lock_schedule_algorithm=FCFS

mysqlx_port=@mysqld.2.loose-mysqlx-port

[mysqld.3]
log-bin=master-bin
log-bin-index=master-bin
server-id=3
# lock schedule alg appears to be VATS by default, and it is not
# yet compatible with galera
#innodb_lock_schedule_algorithm=FCFS

mysqlx_port=@mysqld.3.loose-mysqlx-port


[ENV]
NODE_MYPORT_1= @mysqld.1.port
NODE_MYSOCK_1= @mysqld.1.socket

NODE_MYPORT_2= @mysqld.2.port
NODE_MYSOCK_2= @mysqld.2.socket

NODE_MYPORT_3= @mysqld.3.port
NODE_MYSOCK_3= @mysqld.3.socket
